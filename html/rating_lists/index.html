<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top 100 Standard</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        /* Button styling */
        .back-button {
            display: inline-block;
            margin: 10px;
            padding: 8px 16px;
            text-decoration: none;
            background-color: #ddd;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .back-button:hover {
            background-color: #bbb;
        }
    </style>
</head>
<body>
    <a href="../../../index.html" class="back-button">Back</a>

    <select id="dataTable1">
        <option value="open.txt">Open</option>
        <option value="juniors.txt">Juniors</option>
        <option value="women.txt">Women</option>
        <option value="girls.txt">Girls</option>
    </select>

    <select id="dataTable2">
        <option value="Standard">Classical</option>
        <option value="Rapid">Rapid</option>
        <option value="Blitz">Blitz</option>
    </select>

    <div id="data"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
    
            let globalRows; // to store fetched rows
            let sortDirection = {
                'Rank': true,
                'Name': true,
                'Federation': true,
                'BirthYear': true,
                'Sex': true,
                'Rating': true,
                'RD': true
            };
            let currentSort = {
                column: null,
                direction: null // 'asc' or 'desc'
            };

            document.getElementById('dataTable1').addEventListener('change', loadDataFromDropdowns);
            document.getElementById('dataTable2').addEventListener('change', loadDataFromDropdowns);

            function loadDataFromDropdowns() {
                let timeControl = document.getElementById('dataTable2').value;
                let group = document.getElementById('dataTable1').value;
                loadTableData(timeControl, group);
            }

            function checkWomenGirls() {
                let selectedValue = document.getElementById('dataTable1').value;
                return (selectedValue === 'women.txt' || selectedValue === 'girls.txt');
            }

    
            async function loadTableData(timeControl="Standard", group="open.txt") {
                let baseURL = 'https://raw.githubusercontent.com/yetiowin805/fide-glicko/master/top_rating_lists/';
                let response = await fetch(baseURL + timeControl + '/' + group);
                let data = await response.text();
                let womenGirls = checkWomenGirls();
                globalRows = womenGirls ? 
                data.split('\n').slice(1).filter(row => /^(\d+)\s+(.+?)\s+([A-Z]{3})\s+(\d+)\s+([\d\.]+)\s+([\d\.]+)$/.test(row)) : 
                data.split('\n').slice(1).filter(row => /^(\d+)\s+(.+?)\s+([A-Z]{3})\s+(\d+)\s+([MF])\s+([\d\.]+)\s+([\d\.]+)$/.test(row));  // Only keep rows that match the format

                displayTable(globalRows);
            }

            function getHeaderWithSortArrow(columnName) {
                if (currentSort.column === columnName) {
                    return currentSort.direction === 'asc' ? columnName + ' ↓' : columnName + ' ↑';
                }
                return columnName;
            }

    
            function displayTable(rows) {
                let womenGirls = checkWomenGirls();

                let tableHTML = '<table border="1">';
                tableHTML += '<tr>';
                tableHTML += `<th onclick="sortTable('Rank')">${getHeaderWithSortArrow('Rank')}</th>`;
                tableHTML += `<th onclick="sortTable('Name')">${getHeaderWithSortArrow('Name')}</th>`;
                tableHTML += `<th onclick="sortTable('Federation')">${getHeaderWithSortArrow('Federation')}</th>`;
                tableHTML += `<th onclick="sortTable('BirthYear')">${getHeaderWithSortArrow('BirthYear')}</th>`;
                if (!womenGirls) {
                    tableHTML += `<th onclick="sortTable('Sex')">${getHeaderWithSortArrow('Sex')}</th>`;
                }
                tableHTML += `<th onclick="sortTable('Rating')">${getHeaderWithSortArrow('Rating')}</th>`;
                tableHTML += `<th onclick="sortTable('RD')">${getHeaderWithSortArrow('RD')}</th>`;
                tableHTML += '</tr>';
    
                rows.forEach(row => {
                    if (!womenGirls) {
                        let columns = row.match(/^(\d+)\s+(.+?)\s+([A-Z]{3})\s+(\d+)\s+([MF])\s+([\d\.]+)\s+([\d\.]+)$/);
                        if (columns) {
                            tableHTML += `<tr>
                            <td>${columns[1]}</td>
                            <td>${columns[2]}</td>
                            <td>${columns[3]}</td>
                            <td>${columns[4]}</td>
                            <td>${columns[5]}</td>
                            <td>${columns[6]}</td>
                            <td>${columns[7]}</td>
                            </tr>`;
                        }
                    } else {
                        // Adjusted regex for datasets without 'Sex' column
                        let columns = row.match(/^(\d+)\s+(.+?)\s+([A-Z]{3})\s+(\d+)\s+([\d\.]+)\s+([\d\.]+)$/);
                        if (columns) {
                            tableHTML += `<tr>
                            <td>${columns[1]}</td>
                            <td>${columns[2]}</td>
                            <td>${columns[3]}</td>
                            <td>${columns[4]}</td>
                            <td>${columns[5]}</td>
                            <td>${columns[6]}</td>
                            </tr>`;
                        }
                    }
                });
    
                tableHTML += '</table>';
    
                document.getElementById('data').innerHTML = tableHTML;
            }
    
            window.sortTable = function(column) { // Add to global scope
                let womenGirls = checkWomenGirls();

                let rows = [...globalRows];

                let columnIndices = womenGirls ? {
                    'Rank': 1,
                    'Name': 2,
                    'Federation': 3,
                    'BirthYear': 4,
                    'Rating': 5,
                    'RD': 6
                } : {
                    'Rank': 1,
                    'Name': 2,
                    'Federation': 3,
                    'BirthYear': 4,
                    'Sex': 5,
                    'Rating': 6,
                    'RD': 7
                };

                rows.sort((a, b) => {
                    let columnsA = womenGirls ? 
                    a.match(/^(\d+)\s+(.+?)\s+([A-Z]{3})\s+(\d+)\s+([\d\.]+)\s+([\d\.]+)$/) : 
                    a.match(/^(\d+)\s+(.+?)\s+([A-Z]{3})\s+(\d+)\s+([MF])\s+([\d\.]+)\s+([\d\.]+)$/) ;
                    let columnsB = womenGirls ? 
                    b.match(/^(\d+)\s+(.+?)\s+([A-Z]{3})\s+(\d+)\s+([\d\.]+)\s+([\d\.]+)$/) : 
                    b.match(/^(\d+)\s+(.+?)\s+([A-Z]{3})\s+(\d+)\s+([MF])\s+([\d\.]+)\s+([\d\.]+)$/) ;

                    let aValue = columnsA[columnIndices[column]];
                    let bValue = columnsB[columnIndices[column]];

                    // Check for numeric values and convert if necessary
                    if (!isNaN(aValue)) {
                        aValue = parseFloat(aValue);
                        bValue = parseFloat(bValue);
                        return sortDirection[column] ? aValue - bValue : bValue - aValue;
                    } else {
                        return sortDirection[column] ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                    }
                });
                // Toggle the sort direction or set to 'asc' if a new column is clicked
                if (currentSort.column === column) {
                    currentSort.direction = (currentSort.direction === 'asc') ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'asc';
                }

                sortDirection[column] = !sortDirection[column];
                displayTable(rows);
            }
            loadTableData();
    
        });
    </script>

</body>
</html>
